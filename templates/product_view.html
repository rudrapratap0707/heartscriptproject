<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }} | HeartScript Exclusive</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:ital,wght@0,700;1,400&family=Great+Vibes&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #ff416c; --dark: #0f0f0f; --gold: #c5a059; --soft: #fffafa; --accent: #7b1113; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background: var(--soft); color: #333; overflow-x: hidden; }
        
        /* Navbar */
        nav { padding: 15px 8%; background: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.05); position: sticky; top:0; z-index: 1000; }
        .logo { font-family: 'Great Vibes', cursive; color: var(--primary); text-decoration: none; font-size: 30px; }
        .nav-right { display: flex; align-items: center; gap: 20px; }
        .nav-right a { text-decoration: none; color: #333; font-weight: 500; font-size: 0.9rem; transition: 0.3s; position: relative; }
        .nav-right a:hover { color: var(--primary); }

        /* Wishlist Badge in Nav */
        #wish-count-badge {
            position: absolute; top: -8px; right: -12px; background: var(--primary);
            color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 50%; font-weight: bold;
        }

        .container { max-width: 1200px; margin: 50px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: start; }
        
        /* Left: Image Section */
        .image-box { position: sticky; top: 100px; border-radius: 30px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.1); background: white; position: relative; }
        .image-box img { width: 100%; height: auto; display: block; transition: 0.5s; }
        .image-box:hover img { transform: scale(1.05); }

        /* Wishlist Heart Button */
        .wishlist-btn {
            position: absolute; top: 20px; right: 20px; background: white; width: 45px; height: 45px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: none; z-index: 10;
        }
        .wishlist-btn i { font-size: 1.2rem; color: #ccc; transition: 0.3s; }
        .wishlist-btn.active i { color: var(--primary) !important; }

        /* Wishlist Sidebar */
        #wishlist-sidebar {
            position: fixed; right: -400px; top: 0; width: 350px; height: 100%;
            background: white; z-index: 3000; box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            transition: 0.4s ease-in-out; padding: 30px; overflow-y: auto;
        }
        #wishlist-sidebar.open { right: 0; }
        .wish-item { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .wish-item img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; }
        .wish-item-info h4 { margin: 0; font-size: 0.9rem; }
        .wish-item-info p { margin: 5px 0 0; color: var(--primary); font-weight: bold; font-size: 0.85rem; }

        /* Right: Content Section */
        .content-box h1 { font-family: 'Playfair Display', serif; font-size: 3rem; color: #4a0404; margin: 0 0 10px 0; }
        .category-tag { color: var(--gold); font-weight: 600; text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem; }
        .price { font-size: 2.2rem; color: var(--primary); font-weight: 600; margin: 20px 0; display: block; }
        
        .description-box { line-height: 1.8; color: #555; font-size: 1.1rem; margin-bottom: 30px; }
        .description-box b { color: var(--dark); }

        /* Action Buttons */
        .btn-group { display: flex; flex-direction: column; gap: 15px; }
        .btn-order { 
            background: var(--dark); color: white; padding: 18px 40px; border-radius: 50px; 
            border: none; font-size: 1.1rem; font-weight: 600; cursor: pointer; 
            width: 100%; transition: 0.4s; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .btn-order:hover { background: var(--primary); transform: translateY(-3px); }
        
        .btn-wa {
            background: #25D366; color: white; padding: 18px 40px; border-radius: 50px;
            text-decoration: none; display: flex; align-items: center; justify-content: center;
            gap: 10px; font-weight: 600; font-size: 1.1rem; transition: 0.4s;
        }
        .btn-wa:hover { background: #1eb954; transform: translateY(-3px); }

        .insta-link-box { margin-top: 20px; text-align: center; padding: 10px; border: 1px dashed var(--gold); border-radius: 15px; }
        .insta-link-box a { text-decoration: none; color: #555; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .insta-link-box i { color: #E1306C; font-size: 1.1rem; }

        .trust-points { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; border-top: 1px solid #eee; padding-top: 30px; }
        .point { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: #666; }
        .point i { color: var(--gold); }

        /* Modal Styles */
        #modal-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; 
            backdrop-filter: blur(8px); padding: 20px;
        }
        .modal-content { 
            background: white; padding: 40px; border-radius: 25px; width: 100%; max-width: 500px; 
            max-height: 90vh; overflow-y: auto; position: relative;
        }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; box-sizing: border-box;}
        .btn-submit { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 50px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        .promo-banner { background: #0f0f0f; color: white; padding: 60px 20px; text-align: center; border-radius: 30px; margin: 80px 0; }
        .promo-banner h2 { font-family: 'Great Vibes', cursive; font-size: 3rem; color: var(--primary); margin: 0; }
        .related-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 30px; margin-top: 30px; }
        .small-card { background: white; border-radius: 20px; overflow: hidden; text-decoration: none; color: inherit; border: 1px solid #f0f0f0; transition: 0.3s; }
        .small-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .small-card img { width: 100%; height: 200px; object-fit: cover; }
        .small-card-info { padding: 15px; text-align: center; }

        @media (max-width: 850px) { .container { grid-template-columns: 1fr; } .content-box h1 { font-size: 2.2rem; } #wishlist-sidebar { width: 85%; } }
    </style>
</head>
<body>

    <nav>
        <a href="/" class="logo">HeartScript</a>
        <div class="nav-right">
            <a href="/shop">Gallery</a>
            <a href="javascript:void(0)" onclick="toggleWishlistSidebar()">
                <i class="fas fa-heart" style="color: var(--primary);"></i>
                <span id="wish-count-badge">0</span>
            </a>
            <a href="https://www.instagram.com/heartscript025" target="_blank" style="color: #E1306C;"><i class="fab fa-instagram"></i></a>
        </div>
    </nav>

    <div id="wishlist-sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h2 style="font-family: 'Playfair Display'; margin:0;">Saved Items</h2>
            <i class="fas fa-times" onclick="toggleWishlistSidebar()" style="cursor:pointer; font-size:1.5rem;"></i>
        </div>
        <div id="wish-list-items">
            </div>
    </div>

    <div class="container">
        <div class="image-box">
            <button id="heart-btn" class="wishlist-btn" onclick="toggleWishlistAction()">
                <i class="fas fa-heart"></i>
            </button>
            <img src="{{ product.image_url }}" alt="{{ product.name }}">
        </div>

        <div class="content-box">
            <span class="category-tag">Premium Masterpiece</span>
            <h1>{{ product.name }}</h1>
            <span class="price">₹{{ product.price }}</span>
            
            <div class="description-box">
                <b>The Story Behind the Stroke:</b><br>
                {{ product.description or "This unique piece is handcrafted with precision and emotion." }}
            </div>

            <div class="btn-group">
                <button class="btn-order" onclick="openCheckout()">
                    <i class="fas fa-bolt"></i> Order Directly (COD)
                </button>

                <a href="javascript:void(0)" class="btn-wa" onclick="openWhatsApp()">
                    <i class="fab fa-whatsapp"></i> Discuss on WhatsApp
                </a>
            </div>

            <div class="insta-link-box">
                <a href="https://www.instagram.com/heartscript025" target="_blank">
                    <i class="fab fa-instagram"></i> See making-of videos on @heartscript025
                </a>
            </div>

            <div class="trust-points">
                <div class="point"><i class="fas fa-feather-alt"></i> 100% Hand-written</div>
                <div class="point"><i class="fas fa-shield-alt"></i> Lifetime Ink Warranty</div>
                <div class="point"><i class="fas fa-truck"></i> Premium Safe Shipping</div>
                <div class="point"><i class="fas fa-certificate"></i> Artist Signed</div>
            </div>
        </div>
    </div>

    <div style="padding: 0 8%;">
        <div class="promo-banner">
            <h2>Beyond Digital Fonts</h2>
            <p>In a world of fast typing, we bring back the intimacy of slow, soulful writing.</p>
        </div>
    </div>

    {% if related %}
    <div style="padding: 0 8% 80px;">
        <h3 style="font-family: 'Playfair Display'; font-size: 2rem;">You Might Also Love</h3>
        <div class="related-grid">
            {% for item in related %}
            <a href="/product/{{ item.id }}" class="small-card">
                <img src="{{ item.image_url }}" alt="{{ item.name }}">
                <div class="small-card-info">
                    <h4 style="margin:0;">{{ item.name }}</h4>
                    <p style="color:var(--primary); font-weight:bold;">₹{{ item.price }}</p>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div id="modal-overlay">
        <div class="modal-content">
            <span onclick="closeCheckout()" style="position:absolute; top:20px; right:25px; font-size:25px; cursor:pointer;">&times;</span>
            <h2 style="font-family: 'Great Vibes'; font-size: 2.5rem; color: var(--primary); text-align: center;">Your HeartScript</h2>
            <p style="text-align:center; font-weight:600; margin-bottom:20px;">{{ product.name }} - ₹{{ product.price }}</p>
            
            <input type="text" id="name" placeholder="Full Name" required>
            <input type="tel" id="phone" placeholder="WhatsApp Number" required>
            <input type="text" id="pincode" placeholder="Pincode" maxlength="6">
            <textarea id="address" placeholder="Shipping Address" rows="2"></textarea>
            <textarea id="details" placeholder="Special details..." rows="3"></textarea>
            
            <button class="btn-submit" id="submit-btn" onclick="submitOrder()">Confirm Order (COD)</button>
        </div>
    </div>

    <script>
        // --- WISHLIST CORE LOGIC ---
        let wishlist = JSON.parse(localStorage.getItem('heartscript_wish')) || [];

        function updateWishlistDisplay() {
            const listContainer = document.getElementById('wish-list-items');
            const badge = document.getElementById('wish-count-badge');
            const heartBtn = document.getElementById('heart-btn');
            
            badge.innerText = wishlist.length;

            // Update main heart button state
            const isCurrentInWish = wishlist.some(item => item.id === "{{ product.id }}");
            if(isCurrentInWish) heartBtn.classList.add('active');
            else heartBtn.classList.remove('active');

            if(wishlist.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; color:#888; margin-top:50px;">Your wishlist is empty</p>';
                return;
            }

            listContainer.innerHTML = wishlist.map((item, index) => `
                <div class="wish-item">
                    <img src="${item.img}" alt="">
                    <div class="wish-item-info" style="flex:1">
                        <a href="${item.link}" style="text-decoration:none; color:inherit;"><h4>${item.name}</h4></a>
                        <p>${item.price}</p>
                    </div>
                    <i class="fas fa-trash-alt" onclick="removeFromWishlist(${index})" style="cursor:pointer; color:#ccc;"></i>
                </div>
            `).join('');
        }

        function toggleWishlistAction() {
            const currentItem = {
                id: "{{ product.id }}",
                name: "{{ product.name }}",
                price: "₹{{ product.price }}",
                img: "{{ product.image_url }}",
                link: window.location.href
            };

            const index = wishlist.findIndex(item => item.id === currentItem.id);
            if(index > -1) {
                wishlist.splice(index, 1);
            } else {
                wishlist.push(currentItem);
                // Visual feedback
                toggleWishlistSidebar(); 
            }

            localStorage.setItem('heartscript_wish', JSON.stringify(wishlist));
            updateWishlistDisplay();
        }

        function removeFromWishlist(index) {
            wishlist.splice(index, 1);
            localStorage.setItem('heartscript_wish', JSON.stringify(wishlist));
            updateWishlistDisplay();
        }

        function toggleWishlistSidebar() {
            document.getElementById('wishlist-sidebar').classList.toggle('open');
        }

        // --- EXISTING FUNCTIONS ---
        function openCheckout() {
            document.getElementById('modal-overlay').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        function closeCheckout() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        function openWhatsApp() {
            const msg = `Hi HeartScript! I'm interested in: {{ product.name }} (₹{{ product.price }})`;
            window.open(`https://wa.me/916394174932?text=${encodeURIComponent(msg)}`, '_blank');
        }

        async function submitOrder() {
            const btn = document.getElementById('submit-btn');
            const data = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                pincode: document.getElementById('pincode').value,
                address: document.getElementById('address').value,
                custom_details: document.getElementById('details').value,
                items: "{{ product.name }}",
                total: "{{ product.price }}",
                email: "customer@heartscript.com",
                house_no: "N/A"
            };

            if(!data.name || !data.phone || !data.address) { alert("Fill all details!"); return; }

            btn.disabled = true; btn.innerText = "Processing...";
            try {
                const response = await fetch('/submit_order', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const resData = await response.json();
                if(resData.status === 'success') window.location.href = `/thank-you/${resData.order_id}`;
                else { alert(resData.message); btn.disabled = false; }
            } catch(e) { alert("Connection failed!"); btn.disabled = false; }
        }

        // Initialize on load
        window.onload = updateWishlistDisplay;
    </script>
</body>
</html>
